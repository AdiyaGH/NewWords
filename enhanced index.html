<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>New Words üéÅ ‚Äî Duo Learning</title>
  <style>
    :root{
      --bg:#fafafa; --card:#fff; --muted:#666; --border:#e5e7eb; --shadow:0 3px 12px rgba(0,0,0,.06);
    }
    body{font-family:system-ui, Arial, sans-serif; margin:24px; background:var(--bg);}
    .card{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:24px;max-width:980px;margin:auto;box-shadow:var(--shadow)}
    h1{margin:0 0 6px 0}
    h2{margin:18px 0 10px}
    p.small{font-size:13px;color:var(--muted)}
    .row{display:flex; gap:14px; flex-wrap:wrap; align-items:center}
    input[type="text"], textarea, select{width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; font-size:16px}
    textarea{min-height:80px}
    button{font-size:16px; padding:10px 14px; border-radius:10px; border:1px solid #cfcfcf; cursor:pointer; background:#fff}
    button:active{transform:translateY(1px)}
    .pill{border:1px solid var(--border); padding:6px 10px; border-radius:999px; background:#fff}
    .tabs{display:flex; gap:8px; margin:10px 0 16px}
    .tab{padding:8px 12px; border:1px solid var(--border); border-radius:10px; cursor:pointer; background:#fff}
    .tab[aria-selected="true"]{background:#111; color:#fff}
    .pane{display:none}
    .pane.active{display:block}
    .word{font-size:28px; font-weight:800; margin:10px 0 4px}
    .pos{font-style:italic; color:var(--muted)}
    .def{font-size:18px; line-height:1.45}
    .example{font-size:14px; color:var(--muted); margin-top:8px}
    table{width:100%; border-collapse:collapse; font-size:15px}
    th, td{border-bottom:1px solid var(--border); text-align:left; padding:10px}
    .right{margin-left:auto}
    .stack{display:grid; gap:10px}
    .hint{font-size:12px; color:#888}
    .badge{font-size:12px; background:#eef2ff; color:#3730a3; padding:2px 8px; border-radius:999px; border:1px solid #c7d2fe}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <div class="card">
    <header class="row">
      <div>
        <h1>New Words üéÅ ‚Äî Duo Learning</h1>
        <p class="small">A tiny ritual for <strong>Word Wednesday</strong> with spaced review, generation practice, and a shared history.</p>
      </div>
      <div class="right">
        <span id="weekBadge" class="badge"></span>
      </div>
    </header>

    <!-- Names / settings -->
    <section aria-label="Settings" class="row" style="margin:10px 0 6px">
      <label class="pill"> Me: <input id="meName" type="text" placeholder="Your name" style="width:160px; margin-left:6px"></label>
      <label class="pill"> Partner: <input id="partnerName" type="text" placeholder="Partner name" style="width:160px; margin-left:6px"></label>
      <button id="saveNames">Save names</button>
      <button id="exportBtn" title="Export history as CSV">Export CSV</button>
      <label class="pill"> Import JSON <input id="importFile" type="file" accept="application/json" style="width:200px; margin-left:6px"></label>
          <label class="pill"> <input id="hideDefs" type="checkbox" style="margin-right:6px"> Hide definitions until I click ‚ÄúReveal‚Äù</label>
    </section>

    <!-- Tabs -->
    <nav class="tabs" role="tablist">
      <button class="tab" role="tab" aria-selected="true" data-target="#tab-today">Today</button>
      <button class="tab" role="tab" data-target="#tab-duo">Duo Mode</button>
      <button class="tab" role="tab" data-target="#tab-history">History</button>
      <button class="tab" role="tab" data-target="#tab-help">How this teaches</button>
    </nav>

    <!-- Today pane -->
    <section id="tab-today" class="pane active">
      <div class="row" style="gap:10px; align-items:flex-end">
        <div>
          <button id="pickBtn">Pick a word</button>
          <button id="speakBtn" disabled>üîä Pronounce</button>
        </div>
        <div class="muted">Pro tip: Try to guess the meaning and write a sentence before revealing the definition. Then click ‚ÄúReveal‚Äù to check yourself.</div>
      </div>
      <div id="display" style="margin-top:8px"></div>

      <h2>Lock it in: write a sentence</h2>
      <div class="stack">
        <label>Sentence using <strong id="currentWordLabel">‚Äî</strong>
          <textarea id="sentenceInput" placeholder="Write your sentence‚Ä¶"></textarea>
        </label>
        <div class="row">
          <select id="authorSelect" style="max-width:220px"></select>
          <button id="saveSentence">Save to History</button>
        </div>
        <p class="hint">Saved items appear on the <em>History</em> tab. Everything is stored locally in your browser.</p>
      </div>
    </section>

    <!-- Duo pane -->
    <section id="tab-duo" class="pane">
      <p class="small">Deal one word per person. Each of you writes a sentence using <em>the other person's</em> word. Trade and review together.</p>
      <div class="row" style="align-items:flex-end">
        <button id="dealBtn">Deal words for both</button>
        <button id="swapBtn">Swap words ‚ÜîÔ∏é</button>
      </div>
      <div class="row" style="gap:20px; margin-top:10px">
        <div class="stack" style="flex:1">
          <h3 id="meHeader">Me</h3>
          <div id="meWord"></div>
          <label>My sentence using partner's word
            <textarea id="meSentence" placeholder="Write your sentence‚Ä¶"></textarea>
          </label>
          <button id="saveMe">Save mine</button>
        </div>
        <div class="stack" style="flex:1">
          <h3 id="partnerHeader">Partner</h3>
          <div id="partnerWord"></div>
          <label>Partner sentence using my word
            <textarea id="partnerSentence" placeholder="(If you're together, type as they dictate)"></textarea>
          </label>
          <button id="savePartner">Save partner's</button>
        </div>
      </div>
    </section>

    <!-- History pane -->
    <section id="tab-history" class="pane">
      <div class="row" style="align-items:center; gap:8px">
        <input id="searchBox" type="text" placeholder="Search word/sentence/author" style="max-width:360px">
        <select id="filterWeek" style="max-width:200px"></select>
        <button id="clearHistory" title="This only clears the local copy on this browser">Clear local history</button>
      </div>
      <div style="overflow:auto; margin-top:8px">
        <table id="historyTable" aria-label="Saved sentences">
          <thead>
            <tr><th>Date</th><th>Week</th><th>Author</th><th>Word</th><th>Sentence</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p class="small">Tip: Do a 1‚Äëminute <em>retrieval quiz</em>: hide the Sentences column (mentally), try to recall yours aloud, then check.</p>
    </section>

    <!-- Help pane -->
    <section id="tab-help" class="pane">
      <h2>How this teaches (quick science)</h2>
      <ul>
        <li><strong>Generation effect:</strong> You create a sentence from the word ‚Üí improves memory more than re‚Äëreading.</li>
        <li><strong>Retrieval practice:</strong> Review prior words and recall without looking first ‚Üí strengthens recall pathways.</li>
        <li><strong>Spacing:</strong> We nudge a weekly <em>Word Wednesday</em> ritual; reviewing past weeks adds spacing.</li>
        <li><strong>Interleaving:</strong> Mix different parts of speech/domains so practice isn‚Äôt samey.</li>
        <li><strong>Dual‚Äëcoding:</strong> Use the üîä button to hear the word + definition; sound + text helps some learners.</li>
        <li><strong>Social accountability:</strong> Duo mode lets you write with/for each other (fun + sticky).</li>
      </ul>
      <p class="small">All data is saved in your browser via <code>localStorage</code>. If you need cloud sync, host a tiny API later.</p>
    </section>

    <p class="small">Word list comes from <code>words.json</code> in the repo. Add {"word","part","def","example"} entries. ‚Äî v2.0</p>
  </div>

  <script>
    // ======= Data & helpers =======
    const FALLBACK=[
      {word:"effervescent",part:"adj.",def:"Bubbly; high-spirited.",example:"Her effervescent laugh filled the room."},
      {word:"verdant",part:"adj.",def:"Green and lush with vegetation.",example:"We hiked through verdant hills."},
      {word:"diaphanous",part:"adj.",def:"Light, delicate, and translucent.",example:"She wore a diaphanous scarf."}
    ];
    let WORDS=[]; let lastWord=""; let currentEntry=null; let voices=[];

    function todayISO(){return new Date().toISOString().slice(0,10)}
    function weekOf(d=new Date()){
      // ISO week number
      const date=new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      const dayNum=(date.getUTCDay()+6)%7; date.setUTCDate(date.getUTCDate()-dayNum+3);
      const firstThursday=new Date(Date.UTC(date.getUTCFullYear(),0,4));
      const weekNum=1+Math.round(((date-firstThursday)/86400000-3+((firstThursday.getUTCDay()+6)%7))/7);
      return `${date.getUTCFullYear()}-W${String(weekNum).padStart(2,'0')}`;
    }

    const store={
      get names(){try{return JSON.parse(localStorage.getItem('nww_names')||"{}");}catch{ return {};}}
      ,set names(v){localStorage.setItem('nww_names', JSON.stringify(v||{}));}
      ,get history(){try{return JSON.parse(localStorage.getItem('nww_history')||"[]");}catch{return []}}
      ,set history(v){localStorage.setItem('nww_history', JSON.stringify(v||[]));}
      ,get hide(){ try{return JSON.parse(localStorage.getItem('nww_hide')||'false');}catch{return false} }
      ,set hide(v){ localStorage.setItem('nww_hide', JSON.stringify(!!v)); }
    };}}
      ,set names(v){localStorage.setItem('nww_names', JSON.stringify(v||{}));}
      ,get history(){try{return JSON.parse(localStorage.getItem('nww_history')||"[]");}catch{return []}}
      ,set history(v){localStorage.setItem('nww_history', JSON.stringify(v||[]));}
    };

    async function loadWords(){
      try{
        const r=await fetch('words.json',{cache:'no-store'}); if(!r.ok) throw new Error('fetch failed');
        WORDS=await r.json();
      }catch{ WORDS=FALLBACK; }
    }
    function pickWord(){
      if(!WORDS.length) return null;
      let i=Math.floor(Math.random()*WORDS.length);
      if(WORDS.length>1 && WORDS[i].word===lastWord){ i=Math.floor(Math.random()*WORDS.length); }
      lastWord=WORDS[i].word; return WORDS[i];
    }

    // ======= Speech =======
    function speak(text){
      if(!('speechSynthesis' in window)){ alert('Sorry‚Äîyour browser does not support speech.'); return; }
      const u=new SpeechSynthesisUtterance(text);
      if(voices.length===0) voices=window.speechSynthesis.getVoices();
      const pick=voices.find(v=>/^en(-|_)?(US|GB|AU|CA|IN)/i.test(v.lang))||voices[0];
      if(pick) u.voice=pick; u.rate=1.0; u.pitch=1.0;
      window.speechSynthesis.cancel(); window.speechSynthesis.speak(u);
    }
    window.speechSynthesis.onvoiceschanged=()=>{ voices=window.speechSynthesis.getVoices(); };

    // ======= UI rendering =======
    function renderWord(entry, targetEl, showDef=true){
      if(showDef){
        targetEl.innerHTML = `
          <div class="word">${entry.word}</div>
          <div class="pos">${entry.part||''}</div>
          <div class="def">${entry.def||''}</div>
          ${entry.example?`<div class="example">Example: ‚Äú${entry.example}‚Äù</div>`:''}
        `;
      } else {
        targetEl.innerHTML = `
          <div class="word">${entry.word}</div>
          <div class="pos">${entry.part||''}</div>
          <button class="pill" id="revealBtn_${entry.word.replace(/[^a-z0-9]/gi,'_')}">Reveal definition</button>
        `;
        const btn = targetEl.querySelector('[id^="revealBtn_"]');
        btn.onclick = ()=> renderWord(entry, targetEl, true);
      }
    }

    function renderCurrent(entry){
      currentEntry=entry; const box=document.getElementById('display');
      renderWord(entry, box, !store.hide);
      document.getElementById('currentWordLabel').textContent = entry.word;
      const speakBtn=document.getElementById('speakBtn');
      speakBtn.disabled=false; speakBtn.onclick=()=>{ const txt=entry.def?`${entry.word}. ${entry.def}`:entry.word; speak(txt); };
    }

    function setTab(targetId){
      document.querySelectorAll('.pane').forEach(p=>p.classList.remove('active'));
      document.querySelector(targetId).classList.add('active');
      document.querySelectorAll('.tab').forEach(t=>t.setAttribute('aria-selected','false'));
      document.querySelector(`.tab[data-target="${targetId}"]`).setAttribute('aria-selected','true');
    }

    function fillAuthorSelect(){
      const sel=document.getElementById('authorSelect'); sel.innerHTML='';
      const {me="Me", partner="Partner"}=store.names; [me, partner].forEach(n=>{
        const opt=document.createElement('option'); opt.value=n; opt.textContent=n; sel.appendChild(opt);
      });
      document.getElementById('meHeader').textContent = store.names.me||'Me';
      document.getElementById('partnerHeader').textContent = store.names.partner||'Partner';
    }

    function refreshWeekBadge(){
      document.getElementById('weekBadge').textContent = `Week: ${weekOf()}`;
    }

    // ======= History =======
    function addHistory(rec){
      const list=store.history; list.unshift(rec); store.history=list; buildHistoryTable();
    }

    function buildHistoryTable(){
      const q=(document.getElementById('searchBox').value||'').toLowerCase();
      const wk=document.getElementById('filterWeek').value||'';
      const tbody=document.querySelector('#historyTable tbody'); tbody.innerHTML='';
      const data=store.history.filter(r=>{
        const okQ = !q || [r.word, r.sentence, r.author].join(' ').toLowerCase().includes(q);
        const okW = !wk || r.week===wk; return okQ && okW;
      });
      for(const r of data){
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${r.date}</td><td>${r.week}</td><td>${r.author}</td><td><strong>${r.word}</strong></td><td>${r.sentence}</td>`;
        tbody.appendChild(tr);
      }
      // fill week filter options
      const weeks=[...new Set(store.history.map(r=>r.week))];
      const sel=document.getElementById('filterWeek');
      const prior=sel.value; sel.innerHTML='<option value="">All weeks</option>' + weeks.map(w=>`<option>${w}</option>`).join('');
      if(weeks.includes(prior)) sel.value=prior;
    }

    function exportCSV(){
      const rows=[["date","week","author","word","sentence"]].concat(
        store.history.map(r=>[r.date,r.week,r.author,r.word,r.sentence.replaceAll('"','""')])
      );
      const csv=rows.map(r=>r.map(v=>`"${v}"`).join(',')).join('\n');
      const blob=new Blob([csv],{type:'text/csv'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='new-words-history.csv'; a.click(); URL.revokeObjectURL(url);
    }

    function importJSON(file){
      const reader=new FileReader(); reader.onload=e=>{
        try{ const incoming=JSON.parse(e.target.result);
          if(Array.isArray(incoming)){
            const merged=[...incoming, ...store.history]; // naive prepend
            store.history=merged; buildHistoryTable();
            alert('Imported '+incoming.length+' records.');
          } else { alert('Invalid file format (expecting an array).'); }
        }catch{ alert('Could not parse JSON file.'); }
      }; reader.readAsText(file);
    }

    // ======= Duo mode =======
    let duoMe=null, duoPartner=null;
    function dealBoth(){ duoMe=pickWord(); duoPartner=pickWord();
      if(duoPartner && duoMe && duoPartner.word===duoMe.word) duoPartner=pickWord();
      renderWord(duoMe, document.getElementById('meWord'), !store.hide);
      renderWord(duoPartner, document.getElementById('partnerWord'), !store.hide);
    }
    function swapWords(){ const tmp=duoMe; duoMe=duoPartner; duoPartner=tmp; dealRenderOnly(); }
    function dealRenderOnly(){
      if(duoMe) renderWord(duoMe, document.getElementById('meWord'), !store.hide);
      if(duoPartner) renderWord(duoPartner, document.getElementById('partnerWord'), !store.hide);
    }

    // ======= Init & events =======
    async function init(){
      refreshWeekBadge();
      // tabs
      document.querySelectorAll('.tab').forEach(btn=>btn.addEventListener('click',()=>setTab(btn.dataset.target)));
      // names
      const {me, partner}=store.names; document.getElementById('meName').value=me||''; document.getElementById('partnerName').value=partner||'';
      fillAuthorSelect();
      document.getElementById('saveNames').onclick=()=>{
        store.names={me:document.getElementById('meName').value||'Me', partner:document.getElementById('partnerName').value||'Partner'};
        fillAuthorSelect(); alert('Saved!');
      };
      // hide defs setting
      const hideBox=document.getElementById('hideDefs'); hideBox.checked = !!store.hide;
      hideBox.addEventListener('change', ()=>{ store.hide = hideBox.checked; });

      // words
      await loadWords();
      document.getElementById('pickBtn').onclick=()=>{ const e=pickWord(); if(e) renderCurrent(e); };
      document.getElementById('speakBtn').disabled=true;

      // save sentence
      document.getElementById('saveSentence').onclick=()=>{
        if(!currentEntry){ alert('Pick a word first.'); return; }
        const sentence=(document.getElementById('sentenceInput').value||'').trim();
        if(!sentence){ alert('Write a sentence first.'); return; }
        addHistory({
          date: todayISO(), week: weekOf(), author: document.getElementById('authorSelect').value,
          word: currentEntry.word, sentence
        });
        document.getElementById('sentenceInput').value=''; setTab('#tab-history');
      };

      // duo
      document.getElementById('dealBtn').onclick=()=>{ if(!WORDS.length) return; dealBoth(); };
      document.getElementById('swapBtn').onclick=()=>{ if(!duoMe||!duoPartner) return; const t=duoMe; duoMe=duoPartner; duoPartner=t; dealRenderOnly(); };
      document.getElementById('saveMe').onclick=()=>{
        if(!duoPartner){ alert('Deal words first.'); return; }
        const s=(document.getElementById('meSentence').value||'').trim(); if(!s){ alert('Write your sentence.'); return; }
        addHistory({date:todayISO(), week:weekOf(), author:(store.names.me||'Me'), word:duoPartner.word, sentence:s});
        document.getElementById('meSentence').value='';
      };
      document.getElementById('savePartner').onclick=()=>{
        if(!duoMe){ alert('Deal words first.'); return; }
        const s=(document.getElementById('partnerSentence').value||'').trim(); if(!s){ alert("Write partner's sentence."); return; }
        addHistory({date:todayISO(), week:weekOf(), author:(store.names.partner||'Partner'), word:duoMe.word, sentence:s});
        document.getElementById('partnerSentence').value='';
      };

      // history
      buildHistoryTable();
      document.getElementById('searchBox').addEventListener('input', buildHistoryTable);
      document.getElementById('filterWeek').addEventListener('change', buildHistoryTable);
      document.getElementById('clearHistory').onclick=()=>{
        if(confirm('Clear local history on this browser?')){ store.history=[]; buildHistoryTable(); }
      };

      // import/export
      document.getElementById('exportBtn').onclick=exportCSV;
      document.getElementById('importFile').addEventListener('change', (e)=>{ const f=e.target.files?.[0]; if(f) importJSON(f); e.target.value=''; });

      // initial nudge
      if(new Date().getDay()===3){ // Wednesday
        const n=document.createElement('div'); n.className='small'; n.textContent='Happy Word Wednesday! Pick a word and write your sentence.'; document.querySelector('.card').prepend(n);
      }
    }
    init();
  </script>
</body>
</html>
